<!doctype html>
<html>
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>ECG Analyzer</title>
<style>
  body{font-family:system-ui,Segoe UI,Inter,Arial;margin:18px;background:#0b1220;color:#e5e7eb}
  input,select,button,textarea{background:#0f172a;color:#e5e7eb;border:1px solid #1f2937;border-radius:10px;padding:8px}
  button{cursor:pointer}
  .muted{color:#9aa3b2}
  .card{background:#101827;border:1px solid #1f2937;border-radius:14px;padding:14px;margin-bottom:12px}
  #preview{width:100%;max-width:900px;background:#091020;border:1px solid #1f2937;border-radius:10px;display:block;margin-top:10px}
  #result{white-space:pre-wrap;background:#0f172a;border:1px solid #1f2937;border-radius:10px;padding:10px}
</style>
</head>
<body>
  <h2>ECG Analyzer</h2>
  <p class="muted">Upload ECG → server analyzes with ChatGPT → structured answer. (Educational aid only.)</p>

  <div class="card">
    <h3>1) Upload ECG</h3>
    <input id="file" type="file" accept="image/*">
    <div style="display:flex;gap:8px;align-items:center;margin-top:10px">
      <label>Speed <select id="speed"><option>25</option><option>50</option></select></label>
      <label>Gain <select id="gain"><option>10</option><option>5</option><option>20</option></select></label>
    </div>
    <canvas id="preview"></canvas>
    <div id="imgInfo" class="muted" style="margin-top:6px"></div>
  </div>

  <div class="card">
    <h3>2) Reference notes (optional)</h3>
    <textarea id="refs" style="width:100%;height:110px" placeholder="Paste distilled rules from your books (no book names)."></textarea>
  </div>

  <div class="card">
    <h3>3) Analyze</h3>
    <button id="analyze">Analyze ECG</button>
    <span id="status" class="muted" style="margin-left:8px">Ready.</span>
    <h3 style="margin-top:14px">Result</h3>
    <pre id="result">No analysis yet.</pre>
  </div>

<script>
const $ = s => document.querySelector(s);
const canvas = $("#preview");
const ctx = canvas.getContext("2d", { willReadFrequently:true });
let base64Image = null;

$("#file").addEventListener("change", async (e)=>{
  const f = e.target.files?.[0]; if(!f) return;
  base64Image = await readAndCompress(f, 2000, 1600, 0.9); // compress to keep request small
  drawPreview(base64Image);
  $("#imgInfo").textContent = "Image compressed and ready.";
  $("#status").textContent = "Image ready.";
});

$("#analyze").addEventListener("click", async ()=>{
  if(!base64Image) return alert("Upload an ECG image first.");
  const payload = {
    image_base64: base64Image,
    paper_speed: $("#speed").value,
    paper_gain: $("#gain").value,
    reference_notes: $("#refs").value || ""
  };
  $("#status").textContent = "Analyzing…";
  $("#result").textContent = "Calling server…";
  try{
    // same origin call; Netlify will route this to your function
    const res = await fetch("/.netlify/functions/ecg", {
      method: "POST",
      headers: { "Content-Type":"application/json" },
      body: JSON.stringify(payload)
    });
    const data = await res.json();
    if(!res.ok || !data.ok) throw new Error(data.error || "Server error");
    $("#status").textContent = "Done.";
    $("#result").textContent = formatResult(data.interpretation);
  }catch(err){
    $("#status").textContent = "Error.";
    $("#result").textContent = String(err);
  }
});

/* helpers */
function drawPreview(dataUrl){
  const img = new Image();
  img.onload = () => {
    const maxW = 1100, pad = 6;
    const scale = Math.min(maxW/(img.width+2*pad), 1);
    canvas.width = Math.floor(img.width*scale)+2*pad;
    canvas.height = Math.floor(img.height*scale)+2*pad;
    ctx.fillStyle = "#0a1325"; ctx.fillRect(0,0,canvas.width,canvas.height);
    ctx.drawImage(img, pad, pad, img.width*scale, img.height*scale);
  };
  img.src = dataUrl;
}
function readAndCompress(file, maxW=2000, maxH=1600, q=0.9){
  return new Promise((resolve)=>{
    const fr = new FileReader();
    fr.onload = () => {
      const img = new Image();
      img.onload = () => {
        const ratio = Math.min(maxW/img.width, maxH/img.height, 1);
        const w = Math.round(img.width*ratio), h = Math.round(img.height*ratio);
        const c = document.createElement("canvas");
        c.width = w; c.height = h;
        c.getContext("2d").drawImage(img, 0, 0, w, h);
        resolve(c.toDataURL("image/jpeg", q));
      };
      img.src = fr.result;
    };
    fr.readAsDataURL(file);
  });
}
function formatResult(r){
  const s = r.structured || {};
  const i = s.intervals || {};
  const red = (r.red_flags||[]).map(x=>`  - ${x}`).join("\\n");
  return [
    `Summary: ${r.summary || "—"}`,
    "",
    "Structured:",
    `  Rate: ${s.rate_bpm ?? "—"} bpm`,
    `  Rhythm: ${s.rhythm ?? "—"}`,
    `  Axis: ${s.axis ?? "—"}`,
    `  Intervals: PR ${i.PR_ms ?? "—"} ms | QRS ${i.QRS_ms ?? "—"} ms | QTc ${i.QTc_ms ?? "—"} ms`,
    `  ST/T: ${s.st_changes ?? "—"}; T waves: ${s.t_wave ?? "—"}`,
    `  Blocks: ${s.blocks ?? "—"}; Hypertrophy: ${s.hypertrophy ?? "—"}`,
    red ? "\\nRed flags:\\n"+red : ""
  ].join("\\n");
}
</script>
</body>
</html>
